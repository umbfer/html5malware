<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Using HTML5 to prevent detection of drive-by-download web malware by umbfer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Using HTML5 to prevent detection of drive-by-download web malware</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/umbfer/html5malware" class="btn">View on GitHub</a>
      <a href="https://github.com/umbfer/html5malware/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/umbfer/html5malware/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>The web is experiencing an explosive growth. New technologies are introduced at a very fast-pace with the aim of narrowing the gap between web-based applications and traditional desktop applications. However, these advancements come at a price. The same technologies can also be used to implement web malware able to evade common detection techniques. In our article we present some obfuscation techniques based on HTML5, which can be used to deceive popular malware detection systems. The proposed techniques have been experimented on a reference set of obfuscated malware. Our results show that the malware rewritten using our obfuscation techniques go undetected while being analyzed by a large number of detection systems. Indeed, the same detection systems were able to correctly identify the same malware in its original unobfuscated form. We also provide some hints about how the existing malware detection systems can be enhanced in order to cope with these new threats.</p>

<h2>
<a id="drive-by-download-malware" class="anchor" href="#drive-by-download-malware" aria-hidden="true"><span class="octicon octicon-link"></span></a>Drive-by Download Malware</h2>

<p>One of the most common attack spread through the web is the drive-by download, which developed into exploit kits. In these attacks, the unaware user visits a web page containing malicious code, typically written in JavaScript. The malicious code acquires information on the context where it is executed in order to determine which exploits can be used to compromise the system. If a vulnerable component is found, the corresponding exploit is launched. In case of success, another piece of malware, such as a trojan, is downloaded and executed on the compromised machine.</p>

<p>Several techniques have been proposed so far for detecting web malware. The classical approach is that based on signatures, typically used by antivirus software and intrusion detection systems. This is not very effective against web malware, which can leverage the high dynamicity of JavaScript for obfuscation. A much more effective approach is that based on honeyclients, such as <a href="https://wepawet.iseclab.org/">Wepawet</a>, which are able to execute the suspicious code in an emulated environment in order to inspect instructions and data at runtime.</p>

<h2>
<a id="html5-obfuscation" class="anchor" href="#html5-obfuscation" aria-hidden="true"><span class="octicon octicon-link"></span></a>HTML5 Obfuscation</h2>

<p>Our obfuscation techniques leverage some HTML5 APIs in order to deliver and reassemble malicious code in a web page. As preliminary phase, the malicious code is split in a series of chunks. The chunks can be arbitrary small and individually undetectable. When the victim visits the infected web page, an arbitrary complex procedure based on HTML5 is executed in order to reassemble and execute the original malware. This approach allows to avoid typical (de)obfuscation patterns detected by static and dynamic analysis. In particular, we show 3 techniques.</p>

<h3>
<a id="delegated-preparation" class="anchor" href="#delegated-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Delegated preparation.</h3>

<p>This technique allows to avoid (at all or partially) the activities related to the deobfuscation phase by delegating them to the web browser internals, through the WebSQL API or the IndexedDB API. The idea is to split the malicious code into a series of chunks and to recompose it at runtime, as typically occurs for simple (de)obfuscation routines. The difference here is that each chunk is stored in a table entry on the local browser database. Then, when the attack has to take place, the retrieval and preparation of the malicious code is delegated to the database engine through a properly crafted selection query. The same result can be also achieved by means of FileReader and Blob APIs.</p>

<h3>
<a id="distributed-preparation" class="anchor" href="#distributed-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Distributed Preparation.</h3>

<p>Typically, the operations driving the deobfuscation and the execution of a malware would look harmless in themselves but harmful if considered as a whole. The distributed preparation technique aims at deceiving detection systems by breaking-up the execution of a malware code in several simpler pieces to be executed separately in different contexts. Each piece of code would execute its part of the attack and, then, make available the result to the next part. This result can be achieved by executing independent malware activities in different threads through web workers. Moreover, in order to further confuse detection systems, the communication patterns to follow during the execution of the attack would not be established statically but decided at runtime, by evaluating a function that would decide which other web worker would be the target of a communication at the end of a certain step.</p>

<h3>
<a id="user-driven-preparation" class="anchor" href="#user-driven-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>User-driven Preparation.</h3>

<p>The user-driven technique is a variant of the distributed preparation technique. Here, the activities related to the preparation and to the execution of a malware are spread across the time that a victim user spends visiting a single page or a collection of pages, rather than being concentrated in few milliseconds. Moreover, in order to avoid the predictability of the sequence, the execution of the single activities is not automatic but it is triggered by the (unaware) user himself. The content of the page can be organized in such a way that the victim has to perform an exact sequence of steps in order to enjoy the content of the page (e.g., playing a game). By following this sequence, the victim unintentionally drives the execution of the malware. </p>

<p>All the samples published in this repository have been analyzed by means of <a href="https://wepawet.iseclab.org/">Wepawet</a> and <a href="https://www.virustotal.com/">VirusTotal</a>, showing a very low detection ratio.</p>

<h2>
<a id="useful-links" class="anchor" href="#useful-links" aria-hidden="true"><span class="octicon octicon-link"></span></a>Useful links</h2>

<p><a href="http://onlinelibrary.wiley.com/doi/10.1002/sec.1077/abstract">Using HTML5 to prevent detection of drive-by-download web malware</a> Full paper, paywall article<br>
<a href="http://arxiv.org/pdf/1507.03467v1.pdf">Using HTML5 to prevent detection of drive-by-download web malware</a> Preliminary version, free<br>
<a href="www.statistica.uniroma1.it/users/uferraro/experim/malware">HTML5 Obfuscation Examples</a> A copy of the source code used in our experimentations</p>

<h2>
<a id="authors" class="anchor" href="#authors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authors</h2>

<p>Giancarlo De Maio<br>
Lastline, Inc.<br>
<a href="mailto:gdemaio@lastline.com">gdemaio@lastline.com</a></p>

<p>Alfredo De Santis<br>
University of Salerno, Italy<br>
<a href="http://www.di.unisa.it/professori/ads/ads/Home.html">http://www.di.unisa.it/professori/ads/ads/Home.html</a><br>
<a href="mailto:ads@dia.unisa.it">ads@dia.unisa.it</a></p>

<p>Umberto Ferraro Petrillo<br>
University of Rome - La Sapienza, Italy<br>
<a href="http://umbfer.googlepages.com">http://umbfer.googlepages.com</a><br>
<a href="mailto:umberto.ferraro@uniroma1.it">umberto.ferraro@uniroma1.it</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/umbfer/html5malware">Using HTML5 to prevent detection of drive-by-download web malware</a> is maintained by <a href="https://github.com/umbfer">umbfer</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-65451983-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

